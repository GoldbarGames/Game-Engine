# CMakeLists.txt Template for Game Projects - Emscripten/WebAssembly Build
#
# SETUP INSTRUCTIONS:
# 1. Copy this file to your game project directory
# 2. Rename it to CMakeLists.txt
# 3. Update the variables in the "GAME CONFIGURATION" section below
# 4. Copy shell.html from the engine directory to your game directory (or update SHELL_TEMPLATE path)
#
# DIRECTORY STRUCTURE EXPECTED:
#   GameEngine/
#   ├── GameEngine/                    # Engine source (this repo)
#   │   ├── src/ENGINE/                # Engine source files
#   │   ├── CMakeLists.txt             # Engine CMakeLists (builds libENGINE.a)
#   │   └── shell.html                 # HTML template
#   └── YourGame/                      # Your game project
#       ├── CMakeLists.txt             # This file (copied and configured)
#       ├── main.cpp                   # Your game's main.cpp
#       ├── *.cpp / *.h                # Your game's source files
#       ├── assets/                    # Game assets
#       ├── data/                      # Game data (levels, shaders, etc.)
#       └── fonts/                     # Fonts
#
# USAGE:
#   1. Copy local_config.cmake.example to local_config.cmake
#   2. Edit local_config.cmake with your library paths
#   3. Build:
#      cd YourGame
#      mkdir build_wasm && cd build_wasm
#      emcmake cmake ..
#      emmake cmake --build .
#
# Alternatively, pass paths via command line or environment variables:
#   emcmake cmake .. -DGLM_DIR=/path/to/glm -DNLOHMANN_JSON_DIR=/path/to/nlohmann

cmake_minimum_required(VERSION 3.13)

# ==============================================================================
# GAME CONFIGURATION - Update these for your game
# ==============================================================================

# Your game's name (used for output filenames)
set(GAME_NAME "MyGame")

# Path to the GameEngine directory (relative to this CMakeLists.txt)
set(ENGINE_DIR "${CMAKE_SOURCE_DIR}/../GameEngine")

# Path to shell.html template
set(SHELL_TEMPLATE "${ENGINE_DIR}/shell.html")

# Your game's source files (add all your .cpp files here)
set(GAME_SOURCES
    main.cpp
    MyEntity.cpp
    MyEntityFactory.cpp
    MyFileManager.cpp
    MyGUI.cpp
    MyMenuManager.cpp
    MyCutsceneHelper.cpp
    MyEditorHelper.cpp
    # Add more source files as needed:
    # Player.cpp
    # Enemy.cpp
    # etc.
)

# Asset directories to preload (paths relative to this CMakeLists.txt)
# These will be available in the virtual filesystem at runtime
set(ASSET_DIRS
    data
    assets
    fonts
    # bgm
    # se
)

# ==============================================================================
# END GAME CONFIGURATION
# ==============================================================================

project(${GAME_NAME} VERSION 1.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

if(NOT EMSCRIPTEN)
    message(FATAL_ERROR "This CMakeLists.txt is designed for Emscripten builds only. Use Visual Studio for native Windows builds.")
endif()

# Load local configuration file if it exists (not committed to git)
if(EXISTS "${CMAKE_SOURCE_DIR}/local_config.cmake")
    include("${CMAKE_SOURCE_DIR}/local_config.cmake")
    message(STATUS "Loaded local_config.cmake")
endif()

# External library paths - can be set via:
# 1. local_config.cmake file (recommended)
# 2. Command line: -DGLM_DIR=/path/to/glm
# 3. Environment variables: GLM_DIR, NLOHMANN_JSON_DIR
if(NOT GLM_DIR)
    set(GLM_DIR "$ENV{GLM_DIR}" CACHE PATH "Path to GLM library")
endif()
if(NOT NLOHMANN_JSON_DIR)
    set(NLOHMANN_JSON_DIR "$ENV{NLOHMANN_JSON_DIR}" CACHE PATH "Path to nlohmann/json")
endif()

if(NOT GLM_DIR OR NOT EXISTS "${GLM_DIR}")
    message(FATAL_ERROR "GLM_DIR not set or does not exist.\n"
        "Option 1: Copy local_config.cmake.example to local_config.cmake and edit it\n"
        "Option 2: emcmake cmake .. -DGLM_DIR=/path/to/glm\n"
        "Option 3: Set GLM_DIR environment variable")
endif()

if(NOT NLOHMANN_JSON_DIR OR NOT EXISTS "${NLOHMANN_JSON_DIR}")
    message(FATAL_ERROR "NLOHMANN_JSON_DIR not set or does not exist.\n"
        "Option 1: Copy local_config.cmake.example to local_config.cmake and edit it\n"
        "Option 2: emcmake cmake .. -DNLOHMANN_JSON_DIR=/path/to/nlohmann\n"
        "Option 3: Set NLOHMANN_JSON_DIR environment variable")
endif()

message(STATUS "Building ${GAME_NAME} for Emscripten/WebAssembly")
message(STATUS "Engine directory: ${ENGINE_DIR}")
message(STATUS "GLM_DIR: ${GLM_DIR}")
message(STATUS "NLOHMANN_JSON_DIR: ${NLOHMANN_JSON_DIR}")

# Collect engine source files
file(GLOB_RECURSE ENGINE_SOURCES
    "${ENGINE_DIR}/src/ENGINE/*.cpp"
)

# Create executable with both engine and game sources
# (For Emscripten, we compile everything together into one WASM binary)
add_executable(${GAME_NAME} ${ENGINE_SOURCES} ${GAME_SOURCES})

# Include directories
target_include_directories(${GAME_NAME} PRIVATE
    ${ENGINE_DIR}/src
    ${ENGINE_DIR}/src/ENGINE
    ${CMAKE_SOURCE_DIR}
    ${GLM_DIR}
    ${NLOHMANN_JSON_DIR}
)

# Define EMSCRIPTEN macro
target_compile_definitions(${GAME_NAME} PRIVATE
    EMSCRIPTEN=1
    MAKEDLL=0
)

# Emscripten compiler flags
set(EM_COMPILE_FLAGS
    -sUSE_SDL=2
    -sUSE_SDL_IMAGE=2
    -sUSE_SDL_TTF=2
    -sUSE_SDL_MIXER=2
    -sSDL2_IMAGE_FORMATS=["png","jpg"]
)

# Emscripten linker flags
set(EM_LINK_FLAGS
    -sUSE_SDL=2
    -sUSE_SDL_IMAGE=2
    -sUSE_SDL_TTF=2
    -sUSE_SDL_MIXER=2
    -sSDL2_IMAGE_FORMATS=["png","jpg"]
    -sWASM=1
    -sALLOW_MEMORY_GROWTH=1
    -sMAX_WEBGL_VERSION=2
    -sMIN_WEBGL_VERSION=2
    -sFULL_ES3=1
    -sASYNCIFY=0
    -sEXPORTED_RUNTIME_METHODS=["ccall","cwrap"]
    -sEXPORTED_FUNCTIONS=["_main"]
    -sNO_EXIT_RUNTIME=1
    -sFETCH=1
)

# Add shell template if it exists
if(EXISTS ${SHELL_TEMPLATE})
    list(APPEND EM_LINK_FLAGS --shell-file=${SHELL_TEMPLATE})
    message(STATUS "Using shell template: ${SHELL_TEMPLATE}")
else()
    message(WARNING "Shell template not found: ${SHELL_TEMPLATE}")
    message(WARNING "Using default Emscripten shell. Copy shell.html from engine directory for better experience.")
endif()

# Preload asset directories
foreach(ASSET_DIR ${ASSET_DIRS})
    set(ASSET_PATH "${CMAKE_SOURCE_DIR}/${ASSET_DIR}")
    if(EXISTS ${ASSET_PATH})
        list(APPEND EM_LINK_FLAGS --preload-file=${ASSET_PATH}@/${ASSET_DIR})
        message(STATUS "Preloading assets: ${ASSET_DIR}")
    else()
        message(STATUS "Asset directory not found (skipping): ${ASSET_DIR}")
    endif()
endforeach()

# Debug vs Release configuration
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    list(APPEND EM_COMPILE_FLAGS -g -O0)
    list(APPEND EM_LINK_FLAGS -g -O0 -sASSERTIONS=2 -sSAFE_HEAP=1)
    message(STATUS "Build type: Debug")
else()
    list(APPEND EM_COMPILE_FLAGS -O2)
    list(APPEND EM_LINK_FLAGS -O2)
    message(STATUS "Build type: Release")
endif()

# Apply flags
target_compile_options(${GAME_NAME} PRIVATE ${EM_COMPILE_FLAGS})
target_link_options(${GAME_NAME} PRIVATE ${EM_LINK_FLAGS})

# Output settings
set_target_properties(${GAME_NAME} PROPERTIES
    SUFFIX ".html"
    RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/output
)

message(STATUS "Output will be in: ${CMAKE_BINARY_DIR}/output/")
